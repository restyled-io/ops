#!/usr/bin/env bash
set -eu

if [ -z "$1" ]; then
  echo "usage: release-restyled <tag>" >&2
  exit 64
fi

# heroku still exits 0 when the build/push fails, so we have to manually capture
# the output and check that there were no errors before proceeding. N.B. this
# function has the side-effect of combining stdout/stderr, unfortunately.
checked_output() {
  tee output
  grep -Fq Error output && exit 1
  rm output
}

notify_() {
  # shellcheck disable=SC2181
  if [ $? -eq 0 ]; then
    notify "$app" "Deployed as $image"
  else
    notify "$app" "Error deploying $image" 1
  fi
}

image=restyled/restyled.io:$1
app=${2:-restyled-io}

trap notify_ EXIT

tmp=$(mktemp -d)
cd "$tmp"

cat >Dockerfile.web <<EOM
FROM $image
CMD ["/app/restyled.io"]
EOM

cat >Dockerfile.backend <<EOM
FROM $image
CMD ["/app/restyled.io-backend"]
EOM

docker login \
  --username "$HEROKU_EMAIL" \
  --password "$HEROKU_API_KEY" \
  registry.heroku.com

heroku container:push --app "$app" --recursive |& checked_output
heroku container:release --app "$app" web backend
