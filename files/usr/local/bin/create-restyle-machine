#!/usr/bin/env bash
set -e

get_next_machine_name() {
  local prefix n

  read -r prefix n < <(
    restyled-api "/admin/machines" |
      jq --raw-output '.[] | .name' |
      sed 's/-\([0-9]\+\)$/ \1/' |
      sort -r -n -k 2 |
      head -n 1
  )

  echo "$prefix-$((n + 1))"
}

machine_name=$(get_next_machine_name)
instance_type=t2.micro
root_size=16

printf 'Creating new docker machine (%s)\n' "$machine_name"
docker-machine create \
  --driver amazonec2 \
  --amazonec2-root-size "$root_size" \
  --amazonec2-instance-type "$instance_type" \
  --amazonec2-iam-instance-profile RestyleMachine \
  --amazonec2-monitoring \
  "$machine_name"

tmp=$(mktemp)
trap 'rm -f "$tmp"' EXIT

cat >"$tmp" <<'EOM'
#!/bin/sh
set -x

find /tmp -maxdepth 1 \
  -type d -name 'restyler-*' \
  -cmin +$((12 * 60)) \
  -exec rm -r {} +

docker system prune --all --force
EOM

echo 'Adding cron.daily entry for pruning machine'
docker-machine scp "$tmp" "$machine_name:/tmp/prune"
docker-machine ssh "$machine_name" 'sudo mv /tmp/prune /etc/cron.daily/prune'
docker-machine ssh "$machine_name" 'sudo chmod +x /etc/cron.daily/prune'

echo 'Putting machine in service'
restyle-machine-json "$machine_name" |
  restyled-api /admin/machines -d @- |
  jq
