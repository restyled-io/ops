#!/usr/bin/env bash
#
# See https://blog.jondh.me.uk/2018/04/strategies-for-docker-layer-caching-in-circleci/
#
###
set -eu

usage() {
  cat <<EOM
TODO
EOM
}

die_usage() {
  echo "$*" >&2
  usage >&2
  exit 64
}

pull_cached() {
  local prefix

  for prefix; do
    for stage in builder runtime; do
      echo ":: Pulling cached $stage stage (prefix=$prefix)"
      if docker pull "$registry/$name:${prefix}cached-$stage" 2>/dev/null; then
        docker tag "$registry/$name:${prefix}cached-$stage" "$name:cached-$stage"
      fi
    done
  done
}

push_cached() {
  local prefix

  for prefix; do
    for stage in builder runtime; do
      echo ":: Pushing cached $stage stage (prefix=$prefix)"
      docker tag "$name:built-$stage" "$registry/$name:${prefix}cached-$stage"
      docker push "$registry/$name:${prefix}cached-$stage"
    done
  done
}

while getopts r:n:b:t: opt; do
  case "$opt" in
    r) registry="$OPTARG" ;;
    n) name="$OPTARG" ;;
    b) branch=${OPTARG//\//} ;;
    t) tag=$OPTARG ;;
    \?)
      usage
      exit
      ;;
    *) die_usage "Invalid option $opt" ;;
  esac
done
shift $((OPTIND - 1))

[[ -z ${registry:=""} ]] && die_usage "-r is required"
[[ -z ${name:=""} ]] && die_usage "-n is required"
[[ -z ${branch:=""} ]] && die_usage "-b is required"
[[ -z ${tag:=""} ]] && die_usage "-t is required"

pull_cached "" master- "$branch-"

echo ":: Building builder stage"
docker build \
  --tag "$name:built-builder" \
  --target builder \
  --cache-from "$name:built-builder" \
  --cache-from "$name:cached-builder" \
  "$@" \
  .

echo ":: Building runtime stage"
docker build \
  --tag "$name:built-runtime" \
  --cache-from "$name:cached-builder" \
  --cache-from "$name:built-builder" \
  --cache-from "$name:cached-runtime" \
  --cache-from "$name:built-runtime" \
  "$@" \
  .

push_cached "$branch-" ""

echo ":: Pushing final image"
docker tag "$name:built-runtime" "$registry/$name:$tag"
docker push "$registry/$name:$tag"
