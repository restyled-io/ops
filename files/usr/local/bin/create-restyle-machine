#!/usr/bin/env bash
set -e

if [ -n "$1" ]; then
  machine_name=$1
  instance_type=${2:-t2.micro}
  root_size=${3:-16}
else
  echo "Existing machines:"
  restyled-api "/admin/machines" | jq -r '.[] | .name' | sort -n | sed 's/^/  /'
  echo
  read -r -p "Machine name? " machine_name
  read -r -p "Instance type [t2.micro]? " instance_type
  read -r -p "Root size in GB [16]? " root_size
  instance_type=${instance_type:-t2.micro}
  root_size=${root_size:-16}
fi

if [ -z "$machine_name" ]; then
  echo "Empty machine name" >&2
  exit 1
fi

printf 'Creating new docker machine (%s)\n' "$machine_name"
docker-machine create \
  --driver amazonec2 \
  --amazonec2-root-size "$root_size" \
  --amazonec2-instance-type "$instance_type" \
  --amazonec2-iam-instance-profile RestyleMachine \
  --amazonec2-monitoring \
  "$machine_name"

tmp=$(mktemp)
trap 'rm -f "$tmp"' EXIT

cat >"$tmp" <<'EOM'
#!/bin/sh
set -x

find /tmp -maxdepth 1 \
  -type d -name 'restyler-*' \
  -cmin +$((12 * 60)) \
  -exec rm -r {} +

docker system prune --all --force
EOM

echo 'Adding cron.daily entry for pruning machine'
docker-machine scp "$tmp" "$machine_name:/tmp/prune"
docker-machine ssh "$machine_name" 'sudo mv /tmp/prune /etc/cron.daily/prune'
docker-machine ssh "$machine_name" 'sudo chmod +x /etc/cron.daily/prune'

echo 'Putting machine in service'
restyle-machine-json "$machine_name" |
  restyled-api /admin/machines -d @- |
  jq
